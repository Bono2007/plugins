var RootBundle=function(exports,React$1){"use strict";function _interopDefaultLegacy(e){return e&&typeof e==="object"&&"default"in e?e:{default:e}}var React__default=_interopDefaultLegacy(React$1);const ErrorBoundaryContext=React$1.createContext(null);const initialState={didCatch:false,error:null};class ErrorBoundary extends React$1.Component{constructor(props){super(props);this.resetErrorBoundary=this.resetErrorBoundary.bind(this);this.state=initialState}static getDerivedStateFromError(error){return{didCatch:true,error:error}}resetErrorBoundary(){const{error:error}=this.state;if(error!==null){var _this$props$onReset,_this$props;for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key]}(_this$props$onReset=(_this$props=this.props).onReset)===null||_this$props$onReset===void 0?void 0:_this$props$onReset.call(_this$props,{args:args,reason:"imperative-api"});this.setState(initialState)}}componentDidCatch(error,info){var _this$props$onError,_this$props2;(_this$props$onError=(_this$props2=this.props).onError)===null||_this$props$onError===void 0?void 0:_this$props$onError.call(_this$props2,error,info)}componentDidUpdate(prevProps,prevState){const{didCatch:didCatch}=this.state;const{resetKeys:resetKeys}=this.props;if(didCatch&&prevState.error!==null&&hasArrayChanged(prevProps.resetKeys,resetKeys)){var _this$props$onReset2,_this$props3;(_this$props$onReset2=(_this$props3=this.props).onReset)===null||_this$props$onReset2===void 0?void 0:_this$props$onReset2.call(_this$props3,{next:resetKeys,prev:prevProps.resetKeys,reason:"keys"});this.setState(initialState)}}render(){const{children:children,fallbackRender:fallbackRender,FallbackComponent:FallbackComponent,fallback:fallback}=this.props;const{didCatch:didCatch,error:error}=this.state;let childToRender=children;if(didCatch){const props={error:error,resetErrorBoundary:this.resetErrorBoundary};if(typeof fallbackRender==="function"){childToRender=fallbackRender(props)}else if(FallbackComponent){childToRender=React$1.createElement(FallbackComponent,props)}else if(fallback===null||React$1.isValidElement(fallback)){childToRender=fallback}else{throw error}}return React$1.createElement(ErrorBoundaryContext.Provider,{value:{didCatch:didCatch,error:error,resetErrorBoundary:this.resetErrorBoundary}},childToRender)}}function hasArrayChanged(){let a=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];let b=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];return a.length!==b.length||a.some(((item,index)=>!Object.is(item,b[index])))}function MessageBanner(props){if(!props.warn){return null}console.log(`Root: MessageBanner: props=${JSON.stringify(props)}`);const className=`w3-panel w3-display-container ${props.border?"w3-leftbar":""} ${props.border??"w3-border-red"} ${props.color??"w3-pale-red"}`;window.scrollTo(0,0);return React.createElement("div",{className:className},React.createElement("span",{onClick:()=>props.hide(),className:"w3-button w3-display-right"},"X"),React.createElement("p",null,props.msg))}const ErrorFallback=({error:error})=>React.createElement("div",{role:"alert"},React.createElement("h1",null,"Something went wrong in React:"),React.createElement("pre",null,error.message),React.createElement("p",null),React.createElement("p",null,"More detail:"),React.createElement("pre",null,JSON.stringify(error,null,2)));const consoleStyle="background: #222; color: #62AFEC";const logDebug=(msg,...args)=>console.log(`${window.webkit?"":"%c"}${msg}`,consoleStyle,...args);const logSubtle=(msg,...args)=>console.log(`${window.webkit?"":"%c"}${msg}`,"color: #6D6962",...args);const myErrorLogger=(error,info)=>{console.log(`${window.webkit?"":"%c"}React error trapped by Root::ErrorBoundary; error=${JSON.stringify(error,null,2)},\ninfo=${JSON.stringify(info,null,2)}`,"background: #ff0000; color: #ffffff")};const{lastUpdated:lastUpdated=null,returnPluginCommand:returnPluginCommand={},debug:debug=false,ENV_MODE:ENV_MODE}=globalSharedData;if(typeof globalSharedData==="undefined"||!globalSharedData)logDebug("Root: Root: globalSharedData is undefined",globalSharedData);if(typeof globalSharedData==="undefined")throw globalSharedData;if(typeof globalSharedData.lastUpdated==="undefined")throw`Root: globalSharedData.lastUpdated is undefined`;function Root(props){const[npData,setNPData]=React__default["default"].useState(globalSharedData);const[warning,setWarning]=React__default["default"].useState({warn:false,msg:"",color:"w3-pale-red"});const[messageFromPlugin,setMessageFromPlugin]=React__default["default"].useState({});const[history,setHistory]=React__default["default"].useState([lastUpdated]);const tempSavedClicksRef=React__default["default"].useRef([]);const MemoizedWebView=React__default["default"].memo(WebView);debug&&logDebug(`Root: Running in Debug mode. Note: <React.StrictMode> is enabled which will run effects twice each time they are rendered. This is to help find bugs in your code.`);const onClickCapture=e=>{if(!debug)return;logDebug(`Root: onClickCapture: ${e.target.tagName} ${e.target.className}`);logDebug(`Root: onClickCapture ${e.type} ${e.target.outerText} e=`,e);tempSavedClicksRef.current.push({date:(new Date).toLocaleDateString(),msg:`UI_CLICK ${e.type} ${e.target.outerText}`})};const dispatch=(action,data,actionDescriptionForLog="")=>{const desc=`${action}${actionDescriptionForLog?`: ${actionDescriptionForLog}`:""}`;data.lastUpdated={msg:desc,date:(new Date).toLocaleString()};onMessageReceived({data:{type:action,payload:data}})};const shouldIgnoreMessage=event=>{const{origin:origin,source:source,data:data}=event;return typeof data==="string"&&data?.startsWith("setImmediate$")||typeof data==="object"&&data?.hasOwnProperty("iframeSrc")||/react-devtools/.test(data?.source)};const onMessageReceived=event=>{const{data:data}=event;if(!shouldIgnoreMessage(event)&&data){try{const{type:type,payload:payload}=event.data;if(!type)throw`onMessageReceived: event.data.type is undefined`,event.data;if(!payload)throw`onMessageReceived: event.data.payload is undefined`,event.data;if(type&&payload){logDebug(`Root: onMessageReceived: ${type} payload:${JSON.stringify(payload,null,2)}`);if(type==="SHOW_BANNER")payload.lastUpdated.msg+=`: ${payload.msg}`;setHistory((prevData=>[...prevData,...tempSavedClicksRef.current,payload.lastUpdated]));tempSavedClicksRef.current=[];switch(type){case"SET_TITLE":document.title=payload.title;break;case"SET_DATA":case"UPDATE_DATA":setNPData((prevData=>({...prevData,...payload})));globalSharedData={...globalSharedData,...payload};logDebug("Root: SET_DATA after setting globalSharedData=",globalSharedData);break;case"SHOW_BANNER":showBanner(payload.msg,payload.color,payload.border);break;case"SEND_TO_PLUGIN":sendToPlugin(payload);break;case"RETURN_VALUE":logDebug(`Root: onMessageReceived: processing payload`);setMessageFromPlugin(payload);break;default:break}}else{logDebug(`Root: onMessageReceived: called but event.data.type and/or event.data.payload is undefined`,event)}}catch(error){logDebug(`Root: onMessageReceived: error=${JSON.stringify(error)}error=${JSON.stringify(error)}`)}}};const sendToPlugin=React__default["default"].useCallback((args=>{const returnPluginCommand=globalSharedData.returnPluginCommand||"undefined";if(returnPluginCommand==="undefined"||!returnPluginCommand?.command||!returnPluginCommand?.id){throw"returnPluginCommand variable is not passed correctly to set up comms bridge. Check your data object which you are sending to invoke React"}if(!returnPluginCommand?.command)throw"returnPluginCommand.cmd is not defined in the intial data passed to the plugin";if(!returnPluginCommand?.id)throw"returnPluginCommand.id is not defined in the intial data passed to the plugin";const{command:command,id:id}=returnPluginCommand;runPluginCommand(command,id,args)}),[]);const showBanner=(msg,color="w3-pale-red",border="w3-border-red")=>{const warnObj={warn:true,msg:msg,color:color,border:border};logDebug(`Root: showBanner: sending: ${JSON.stringify(warnObj)}`);setWarning(warnObj)};const hideBanner=()=>{setWarning({warn:false,msg:"",color:"w3-pale-red"})};const testCommsBridge=()=>{logDebug(`Root: _Root: testCommsBridge`);sendMessageToPlugin(["commsBridgeTest","some sample","data passed"])};function onRender(id,phase,actualDuration,baseDuration,startTime,commitTime,interactions){logSubtle(`\n===================\nPROFILING:${id} phase=${phase} actualDuration=${actualDuration} baseDuration=${baseDuration} startTime=${startTime} commitTime=${commitTime}\n===================\n`)}React$1.useEffect((()=>{window.addEventListener("message",onMessageReceived);return()=>window.removeEventListener("message",onMessageReceived)}),[]);return React__default["default"].createElement(ErrorBoundary,{FallbackComponent:ErrorFallback,onReset:()=>{},onError:myErrorLogger},React__default["default"].createElement("div",{className:"Root",onClickCapture:onClickCapture},React__default["default"].createElement(MessageBanner,{warn:warning.warn,msg:warning.msg,color:warning.color,border:warning.border,hide:hideBanner}),debug?React__default["default"].createElement(React$1.Profiler,{id:"MemoizedWebView",onRender:onRender},React__default["default"].createElement(MemoizedWebView,{dispatch:dispatch,data:npData})):React__default["default"].createElement(MemoizedWebView,{data:npData,dispatch:dispatch}),debug&&React__default["default"].createElement(React__default["default"].StrictMode,null,React__default["default"].createElement("div",{className:"w3-container w3-red w3-margin-top"},"Debugging Data (Plugin passed debug:true at window open)"),React__default["default"].createElement("div",null,React__default["default"].createElement("span",{id:"debugHistory"},"History (most recent first):"),React__default["default"].createElement("ul",null,history.slice().reverse().map(((h,i)=>React__default["default"].createElement("li",{style:{fontSize:"12px"},key:i},"[",h?.date||"","]: ",h?.msg||"")))),React__default["default"].createElement("div",{className:"monospaceData"},"globalSharedData: ",JSON.stringify(globalSharedData,null,2))),React__default["default"].createElement("div",{className:"w3-button w3-black",onClick:()=>dispatch("SHOW_BANNER",{msg:"Banner test succeeded"},`banner test`)},"Local Banner Display Test"),React__default["default"].createElement("div",{className:"w3-button w3-black",onClick:testCommsBridge},"Test Communication Bridge"))))}exports.Root=Root;Object.defineProperty(exports,"__esModule",{value:true});return exports}({},react);Object.assign(typeof globalThis=="undefined"?this:globalThis,RootBundle);
