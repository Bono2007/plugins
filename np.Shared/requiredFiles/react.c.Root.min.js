var RootBundle=function(exports,React$1){"use strict";function _interopDefaultLegacy(e){return e&&typeof e==="object"&&"default"in e?e:{default:e}}var React__default=_interopDefaultLegacy(React$1);const ErrorBoundaryContext=React$1.createContext(null);const initialState={didCatch:false,error:null};class ErrorBoundary extends React$1.Component{constructor(props){super(props);this.resetErrorBoundary=this.resetErrorBoundary.bind(this);this.state=initialState}static getDerivedStateFromError(error){return{didCatch:true,error:error}}resetErrorBoundary(){const{error:error}=this.state;if(error!==null){var _this$props$onReset,_this$props;for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key]}(_this$props$onReset=(_this$props=this.props).onReset)===null||_this$props$onReset===void 0?void 0:_this$props$onReset.call(_this$props,{args:args,reason:"imperative-api"});this.setState(initialState)}}componentDidCatch(error,info){var _this$props$onError,_this$props2;(_this$props$onError=(_this$props2=this.props).onError)===null||_this$props$onError===void 0?void 0:_this$props$onError.call(_this$props2,error,info)}componentDidUpdate(prevProps,prevState){const{didCatch:didCatch}=this.state;const{resetKeys:resetKeys}=this.props;if(didCatch&&prevState.error!==null&&hasArrayChanged(prevProps.resetKeys,resetKeys)){var _this$props$onReset2,_this$props3;(_this$props$onReset2=(_this$props3=this.props).onReset)===null||_this$props$onReset2===void 0?void 0:_this$props$onReset2.call(_this$props3,{next:resetKeys,prev:prevProps.resetKeys,reason:"keys"});this.setState(initialState)}}render(){const{children:children,fallbackRender:fallbackRender,FallbackComponent:FallbackComponent,fallback:fallback}=this.props;const{didCatch:didCatch,error:error}=this.state;let childToRender=children;if(didCatch){const props={error:error,resetErrorBoundary:this.resetErrorBoundary};if(typeof fallbackRender==="function"){childToRender=fallbackRender(props)}else if(FallbackComponent){childToRender=React$1.createElement(FallbackComponent,props)}else if(fallback===null||React$1.isValidElement(fallback)){childToRender=fallback}else{throw error}}return React$1.createElement(ErrorBoundaryContext.Provider,{value:{didCatch:didCatch,error:error,resetErrorBoundary:this.resetErrorBoundary}},childToRender)}}function hasArrayChanged(){let a=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];let b=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];return a.length!==b.length||a.some(((item,index)=>!Object.is(item,b[index])))}function MessageBanner(props){if(!props.warn){return null}console.log(`Root: MessageBanner: props=${JSON.stringify(props)}`);const className=`w3-panel w3-display-container ${props.border?"w3-leftbar":""} ${props.border??"w3-border-red"} ${props.color??"w3-pale-red"}`;window.scrollTo(0,0);return React.createElement("div",{className:className},React.createElement("span",{onClick:()=>props.hide(),className:"w3-button w3-display-right"},"X"),React.createElement("p",null,props.msg))}const PARAM_BLACKLIST=["note","referencedBlocks","availableThemes","currentTheme","linkedNoteTitles","linkedItems"];const dt=()=>{const d=new Date;const pad=value=>value<10?`0${value}`:value.toString();return`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${d.toLocaleTimeString("en-GB")}`};function JSP(obj,space=2){if(typeof obj!=="object"||obj instanceof Date){return String(obj)}else{if(Array.isArray(obj)){const arrInfo=[];let isValues=false;obj.forEach(((item,i)=>{if(typeof item==="object"){arrInfo.push(`[${i}] = ${JSP(item,space)}`)}else{isValues=true;arrInfo.push(`${item}`)}}));return`${isValues?"[":""}${arrInfo.join(isValues?", ":",\n")}${isValues?"]":""}`}const propNames=getFilteredProps(obj);const fullObj=propNames.reduce(((acc,propName)=>{if(!/^__/.test(propName)){if(Array.isArray(obj[propName])){try{if(PARAM_BLACKLIST.indexOf(propName)===-1){acc[propName]=obj[propName].map((x=>{if(typeof x==="object"&&!(x instanceof Date)){return JSP(x,"")}else{return x}}))}else{acc[propName]=obj[propName]}}catch(error){logDebug$1("helpers/dev",`Caught error in JSP for propname=${propName} : ${error} typeof obj[propName]=${typeof obj[propName]} isArray=${String(Array.isArray(obj[propName]))} len=${obj[propName]?.length} \n VALUE: ${JSON.stringify(obj[propName])}`)}}else{acc[propName]=obj[propName]}}return acc}),{});return typeof fullObj==="object"&&!(fullObj instanceof Date)?JSON.stringify(fullObj,null,space??null):"date"}}function clo(obj,preamble="",space=2){if(!obj){logDebug$1(preamble,`null`);return}if(typeof obj!=="object"){logDebug$1(preamble,`${obj}`)}else{logDebug$1(preamble,JSP(obj,space))}}function getAllPropertyNames(inObj){let obj=inObj;const props=[];do{Object.getOwnPropertyNames(obj).forEach((function(prop){if(props.indexOf(prop)===-1){props.push(prop)}}))}while(obj=Object.getPrototypeOf(obj));return props}const getFilteredProps=object=>{const ignore=["toString","toLocaleString","valueOf","hasOwnProperty","propertyIsEnumerable","isPrototypeOf"];if(typeof object!=="object"||Array.isArray(object)){return[]}return getAllPropertyNames(object).filter((prop=>!/(^__)|(constructor)/.test(prop)&&!ignore.includes(prop)))};const _message=message=>{let logMessage="";switch(typeof message){case"string":logMessage=message;break;case"object":if(Array.isArray(message)){logMessage=message.toString()}else{logMessage=message instanceof Date?message.toString():JSON.stringify(message)}break;default:logMessage=message.toString();break}return logMessage};const LOG_LEVELS=["DEBUG","INFO","WARN","ERROR","none"];const LOG_LEVEL_STRINGS=["| DEBUG |","| INFO  |","🥺 WARN🥺","❗️ERROR❗️","none"];function log(pluginInfo,message="",type="INFO"){const thisMessageLevel=LOG_LEVELS.indexOf(type);const thisIndicator=LOG_LEVEL_STRINGS[thisMessageLevel];let msg="";let pluginId="";let pluginVersion="";const isPluginJson=typeof pluginInfo==="object"&&pluginInfo.hasOwnProperty("plugin.id");if(isPluginJson){pluginId=pluginInfo.hasOwnProperty("plugin.id")?pluginInfo["plugin.id"]:"INVALID_PLUGIN_ID";pluginVersion=pluginInfo.hasOwnProperty("plugin.version")?pluginInfo["plugin.version"]:"INVALID_PLUGIN_VERSION";msg=`${dt().padEnd(19)} ${thisIndicator} ${pluginId} v${pluginVersion} :: ${_message(message)}`}else{if(message.length>0){msg=`${dt().padEnd(19)} ${thisIndicator} ${pluginInfo} :: ${_message(message)}`}else{msg=`${dt().padEnd(19)} ${thisIndicator} ${_message(pluginInfo)}`}}let userLogLevel=1;const pluginSettings=typeof DataStore!=="undefined"?DataStore.settings:null;if(pluginSettings&&pluginSettings.hasOwnProperty("_logLevel")){userLogLevel=pluginSettings["_logLevel"]}const userLogLevelIndex=LOG_LEVELS.indexOf(userLogLevel);if(thisMessageLevel>=userLogLevelIndex){console.log(msg)}return msg}function logDebug$1(pluginInfo,message=""){return log(pluginInfo,message,"DEBUG")}function stringToColor(input){let hash=0;for(let i=0;i<input.length;i++){hash=input.charCodeAt(i)+((hash<<5)-hash)}const color=(hash&16777215).toString(16).toUpperCase();const hexColor=`#${`000000${color}`.slice(-6)}`;const rgb=hexToRgb(hexColor);const brightnessAdjusted=adjustBrightness(rgb.r,rgb.g,rgb.b);return`rgb(${brightnessAdjusted.r}, ${brightnessAdjusted.g}, ${brightnessAdjusted.b})`}function hexToRgb(hex){const r=parseInt(hex.slice(1,3),16);const g=parseInt(hex.slice(3,5),16);const b=parseInt(hex.slice(5,7),16);return{r:r,g:g,b:b}}function adjustBrightness(_r,_g,_b){const luminance=.2126*_r+.7152*_g+.0722*_b;const brightnessFactor=luminance<128?.5:.25;const r=Math.floor(Math.min(255,_r+brightnessFactor*255));const g=Math.floor(Math.min(255,_g+brightnessFactor*255));const b=Math.floor(Math.min(255,_b+brightnessFactor*255));return{r:r,g:g,b:b}}const logDebug=(componentName,detail,...args)=>console.log(`${window.webkit?`${componentName}${detail?`: ${detail} `:""}`:`%c${componentName}${detail?`: ${detail} `:""}`}`,`${window.webkit?"":`color: #000; background: ${stringToColor(componentName)}`}`,...args);const logError=(componentName,detail="",...args)=>console.error(`${window.webkit?`${componentName}${detail?`: ${detail} `:""}`:`%c${componentName}${detail?`: ${detail} `:""}`}`,`${window.webkit?"":`color: #F00; background: #FFF`}`,...args);const formatReactError=(error,cs="")=>({name:error.name,message:error.message,inComponent:cs.split("@file",1)[0]?.replace("\n",""),line:error.line||"",column:error.column,componentStack:cs.split("\n").map((s=>s.replace(/\@file.*$/,""))).filter((s=>s.trim()!=="div"&&s.trim()!==""&&s.trim()!=="Root"&&s.trim()!=="ErrorBoundary")).join(" < ")});const ErrorFallback=props=>{clo(props);const{error:error}=props;const formatted=formatReactError(error);return React.createElement("div",{role:"alert"},React.createElement("h1",null,"Something went wrong in React:"),React.createElement("pre",null,formatted.name,": ",formatted.message),React.createElement("p",null),React.createElement("p",null,"See more detail in the console"))};const myErrorLogger=(e,i)=>{const error=formatReactError(e,i.componentStack);console.log(`${window.webkit?"":"%c"}React error trapped by Root::ErrorBoundary; error=${JSP(error,2)}`,"background: #ff0000; color: #ffffff")};const{lastUpdated:lastUpdated=null,debug:debug=false,logProfilingMessage:logProfilingMessage=false}=globalSharedData;if(typeof globalSharedData==="undefined"||!globalSharedData)logDebug("Root: Root: globalSharedData is undefined",globalSharedData);if(typeof globalSharedData==="undefined")throw globalSharedData;if(typeof globalSharedData.lastUpdated==="undefined")throw`Root: globalSharedData.lastUpdated is undefined`;function Root(){const[npData,setNPData]=React$1.useState(globalSharedData);const[reactSettings,setReactSettings]=React$1.useState({});const[warning,setWarning]=React$1.useState({warn:false,msg:"",color:"w3-pale-red",border:"w3-border-red"});const[history,setHistory]=React$1.useState([lastUpdated]);const tempSavedClicksRef=React$1.useRef([]);const MemoizedWebView=WebView;debug&&logDebug(`Root`,` Running in Debug mode. Note: <React.StrictMode> is enabled which will run effects twice each time they are rendered. This is to help find bugs in your code.`);const onClickCapture=e=>{if(!debug)return;logDebug(`Root`,` User ${e.type}-ed on "${e.target.outerText}" (${e.target.tagName}.${e.target.className})`);tempSavedClicksRef.current.push({date:(new Date).toLocaleDateString(),msg:`UI_CLICK ${e.type} ${e.target.outerText}`})};const dispatch=(action,data,actionDescriptionForLog)=>{const event=new MessageEvent("message",{data:{type:action,payload:data}});onMessageReceived(event)};const shouldIgnoreMessage=event=>{const{data:data}=event;return typeof data==="string"&&data?.startsWith("setImmediate$")||typeof data==="object"&&data?.hasOwnProperty("iframeSrc")||typeof data==="object"&&typeof data?.source==="string"&&/react-devtools/.test(data?.source)};function replaceStylesheetContent(oldName,newStyles){const styleSheetsArray=Array.from(document.styleSheets);const oldSheet=styleSheetsArray.find((sheet=>sheet&&sheet.title===oldName));let wasSaved=false;if(oldSheet&&typeof oldSheet.replaceSync==="function"){logDebug(`Root`,`replaceStylesheetContent: found existing stylesheet "${oldName}" Will try to replace it.`);try{oldSheet.replaceSync(newStyles);wasSaved=true}catch(error){logError(`Root`,`Swapping "${oldName}" CSS Failed. replaceStylesheetContent: Error ${JSP(formatReactError(error))}`)}}if(!wasSaved){const newStyle=document.createElement("style");newStyle.title=oldName;newStyle.textContent=newStyles;document?.head?.appendChild(newStyle);testOutputStylesheets();const styleElement=document.querySelector(`style[title="${oldName}"]`);if(styleElement){logDebug("CHANGE_THEME replaceStylesheetContent: VERIFIED: CSS has been successfully added to the document")}else{logDebug("CHANGE_THEME replaceStylesheetContent: CSS has apparently NOT been added. Can't find it in the document")}}}function testOutputStylesheets(){const styleSheets=document.styleSheets;for(let i=0;i<styleSheets.length;i++){const styleSheet=styleSheets[i];try{const rules=styleSheet.cssRules||styleSheet.rules;let cssText="";for(let j=0;j<rules.length;j++){cssText+=rules[j].cssText;if(cssText.length>=55)break}logDebug(`CHANGE_THEME StyleSheet ${i}: "${styleSheet.title??""}": ${cssText.substring(0,55).replace(/\n/g,"")}`)}catch(e){console.warn(`Unable to access stylesheet: ${styleSheet.href}`,e)}}}const onMessageReceived=event=>{const{data:data}=event;if(!shouldIgnoreMessage(event)&&data){try{const{type:type,payload:payload}=event.data;if(!type)throw`onMessageReceived: event.data.type is undefined`,event.data;if(!payload)throw`onMessageReceived: event.data.payload is undefined`,event.data;if(type&&payload){if(!payload.lastUpdated)payload.lastUpdated={msg:"(no msg)"};if(type==="SHOW_BANNER"){if(payload.lastUpdated?.msg){payload.lastUpdated.msg+=`: ${payload.msg}`}else{logDebug(`Root`,` onMessageReceived: payload.lastUpdated.msg is undefined: payload.lastUpdated:${payload.lastUpdated} payload.lastUpdated.msg:${payload.lastUpdated.msg}`)}}setHistory((prevData=>[...prevData,...tempSavedClicksRef.current,payload.lastUpdated]));tempSavedClicksRef.current=[];switch(type){case"SET_TITLE":document.title=payload.title;break;case"SET_DATA":case"UPDATE_DATA":setNPData((prevData=>({...prevData,...payload})));globalSharedData={...globalSharedData,...payload};break;case"CHANGE_THEME":{const{themeCSS:themeCSS}=payload;logDebug(`Root`,`CHANGE_THEME changing theme to "${themeCSS.substring(0,55)}"...`);replaceStylesheetContent("Updated Theme Styles",themeCSS);break}case"SHOW_BANNER":if(npData.passThroughVars.lastWindowScrollTop){logDebug(`Root`,` onMessageReceived: Showing banner, so we need to scroll the page up to the top so user sees it.`);setNPData((prevData=>{prevData.passThroughVars.lastWindowScrollTop=0;return{...prevData,...payload}}))}showBanner(payload.msg,payload.color,payload.border);break;case"SEND_TO_PLUGIN":sendToPlugin(payload);break;case"RETURN_VALUE":break;default:break}}else{logDebug(`Root`,` onMessageReceived: called but event.data.type and/or event.data.payload is undefined`,event)}}catch(error){logDebug(`Root`,` onMessageReceived: error=${JSP(formatReactError(error))}`)}}};const sendToPlugin=React__default["default"].useCallback((([action,data,additionalDetails=""])=>{const returnPluginCommand=globalSharedData.returnPluginCommand||"undefined";if(returnPluginCommand==="undefined"||!returnPluginCommand?.command||!returnPluginCommand?.id){throw"returnPluginCommand variable is not passed correctly to set up comms bridge. Check your data object which you are sending to invoke React"}if(!returnPluginCommand?.command)throw"returnPluginCommand.cmd is not defined in the intial data passed to the plugin";if(!returnPluginCommand?.id)throw"returnPluginCommand.id is not defined in the intial data passed to the plugin";if(!action)throw new Error("sendToPlugin: command/action must be called with a string");if(!data)throw new Error("sendToPlugin: data must be called with an object");console.log(`Root`,` sendToPlugin: command:${action} data=${JSON.stringify(data)} `);const{command:command,id:id}=returnPluginCommand;runPluginCommand(command,id,[action,data,additionalDetails])}),[globalSharedData]);const showBanner=(msg,color="w3-pale-red",border="w3-border-red")=>{const warnObj={warn:true,msg:msg,color:color,border:border};setWarning(warnObj)};const hideBanner=()=>{setWarning({warn:false,msg:"",color:"w3-pale-red",border:"w3-border-red"})};const testCommsBridge=()=>{logDebug(`Root`,` _Root: testCommsBridge`);sendMessageToPlugin(["commsBridgeTest","some sample","data passed"])};function onRender(id,phase,actualDuration,baseDuration,startTime,commitTime,interactions){logDebug(`Root`,`\n===================\nPROFILING:${id} phase=${phase} actualDuration=${actualDuration} baseDuration=${baseDuration} startTime=${startTime} commitTime=${commitTime} ${String(interactions)}\n===================\n`)}React$1.useEffect((()=>{window.addEventListener("message",onMessageReceived);return()=>window.removeEventListener("message",onMessageReceived)}),[]);React$1.useEffect((()=>{if(npData?.passThroughVars?.lastWindowScrollTop!==undefined&&npData.passThroughVars.lastWindowScrollTop!==window.scrollY){window.scrollTo(0,npData.passThroughVars.lastWindowScrollTop)}}),[npData]);return React__default["default"].createElement(ErrorBoundary,{FallbackComponent:ErrorFallback,onReset:()=>{},onError:myErrorLogger},React__default["default"].createElement("div",{className:"Root",onClickCapture:onClickCapture},React__default["default"].createElement(MessageBanner,{warn:warning.warn,msg:warning.msg,color:warning.color,border:warning.border,hide:hideBanner}),logProfilingMessage?React__default["default"].createElement(React$1.Profiler,{id:"MemoizedWebView",onRender:onRender},React__default["default"].createElement(MemoizedWebView,{dispatch:dispatch,data:npData,reactSettings:reactSettings,setReactSettings:setReactSettings})):React__default["default"].createElement(MemoizedWebView,{data:npData,dispatch:dispatch,reactSettings:reactSettings,setReactSettings:setReactSettings}),debug&&React__default["default"].createElement(React__default["default"].StrictMode,null,React__default["default"].createElement("div",{className:"w3-container w3-red w3-margin-top"},"Debugging Data (Plugin passed debug:true at window open)"),React__default["default"].createElement("div",null,React__default["default"].createElement("span",{id:"debugHistory"},"History (most recent first):"),React__default["default"].createElement("ul",null,history.slice().reverse().map(((h,i)=>React__default["default"].createElement("li",{style:{fontSize:"12px"},key:i},"[",h?.date||"","]: ",h?.msg||"")))),React__default["default"].createElement("div",{className:"monospaceData"},"globalSharedData: ",JSON.stringify(globalSharedData,null,2))),React__default["default"].createElement("div",{className:"w3-button w3-black",onClick:()=>dispatch("SHOW_BANNER",{msg:"Banner test succeeded"})},"Local Banner Display Test"),React__default["default"].createElement("div",{className:"w3-button w3-black",onClick:testCommsBridge},"Test Communication Bridge"))))}exports.Root=Root;Object.defineProperty(exports,"__esModule",{value:true});return exports}({},react);Object.assign(typeof globalThis=="undefined"?this:globalThis,RootBundle);
